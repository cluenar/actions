name: Create release PR

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      token:
        description: GitHub access token
      app-id:
        description: GitHub app ID
      private-key:
        description: GitHub app private key

jobs:
  create-release-pr:
    name: Create release PR
    runs-on: ubuntu-latest
    env:
      CLUENAR_ACTIONS_VERSION: v1.0.0
      SECRET_TOKEN: ${{ secrets.token }}
      SECRET_APP_ID: ${{ secrets.app-id || secrets.CLUENAR_PUBLIC_BOT_APP_ID }}
      SECRET_PRIVATE_KEY: ${{ secrets.private-key || secrets.CLUENAR_PUBLIC_BOT_PRIVATE_KEY }}

    steps:
      - name: Check required secrets
        if: env.SECRET_TOKEN == null && (env.SECRET_APP_ID == null || env.SECRET_PRIVATE_KEY == null)
        run: exit 1
        shell: bash

      - name: Set cluenar/actions version
        if: github.event_name != 'workflow_call'
        run: echo "CLUENAR_ACTIONS_VERSION=main" >> $GITHUB_ENV

      - name: Get bot token
        id: get-bot-token
        if: env.SECRET_TOKEN == null
        uses: cluenar/actions/get-github-app-token@${{ env.CLUENAR_ACTIONS_VERSION }}
        with:
          app-id: ${{ env.SECRET_APP_ID }}
          private-key: ${{ env.SECRET_PRIVATE_KEY }}

      - name: Install
        uses: cluenar/actions/install@${{ env.CLUENAR_ACTIONS_VERSION }}
        with:
          fetch-depth: 0

      - name: Run the release script
        id: release
        run: npm run release create

      - name: Create a pull request with the release
        if: github.event_name == 'workflow_dispatch'
        uses: branoholy/update-files-action@main
        with:
          token: ${{ steps.get-bot-token.outputs.token }}
          branch.name: release-${{ steps.release.outputs.version }}
          branch.recreate: true
          commit.paths: |
            package.json
            package-lock.json
            CHANGELOG.md
            .github/workflows/*.yaml
          commit.message: 'release: Version ${{ steps.release.outputs.version }}'
          commit.token: ${{ steps.get-bot-token.outputs.token }}
          pull-request.body: Release ${{ steps.release.outputs.version }}.
          pull-request.labels: 'type: release'

      - name: Create a pull request with the release
        if: github.event_name == 'workflow_call'
        uses: branoholy/update-files-action@main
        with:
          token: ${{ env.SECRET_TOKEN || steps.get-bot-token.outputs.token }}
          branch.name: release-${{ steps.release.outputs.version }}
          branch.recreate: true
          commit.paths: |
            package.json
            package-lock.json
            CHANGELOG.md
          commit.message: 'release: Version ${{ steps.release.outputs.version }}'
          commit.token: ${{ steps.get-bot-token.outputs.token || secrets.GITHUB_TOKEN }}
          pull-request.body: Release ${{ steps.release.outputs.version }}.
          pull-request.labels: 'type: release'
